<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pablo - AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: black;
            color: #E5E7EB;
        }
        .chat-bubble {
            max-width: 75%;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
        }
        .user-bubble {
            background-color: #4F46E5;
            color: white;
            border-bottom-right-radius: 0;
            margin-left: auto;
        }
        .ai-bubble {
            background-color: #374151;
            color: #E5E7EB;
            border-bottom-left-radius: 0;
            margin-right: auto;
        }
        .message-input {
            width: 100%;
            padding: 1rem;
            padding-right: 4rem;
            border-radius: 1rem;
            background-color: #374151;
            color: #E5E7EB;
            resize: none;
            transition: background-color 0.3s;
        }
        .message-input:focus {
            outline: none;
            ring: 2px;
            ring-color: #4F46E5;
        }
        .send-button {
            background-color: #4F46E5;
            color: white;
            padding: 0.5rem;
            border-radius: 9999px;
            transition: background-color 0.3s;
        }
        .send-button:hover {
            background-color: #6366F1;
        }
        .send-button:disabled {
            background-color: #4B5563;
            color: #9CA3AF;
        }
        .spinner > div {
            animation-name: bounce;
            animation-duration: 1.4s;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
            animation-fill-mode: both;
        }
        .spinner > div:nth-child(1) { animation-delay: -0.32s; }
        .spinner > div:nth-child(2) { animation-delay: -0.16s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="flex flex-col h-screen p-4">

    <div class="flex flex-col items-center justify-center h-full w-full">
        <!-- Chat Header -->
        <header class="bg-gray-800 p-4 rounded-xl shadow-lg mb-4 text-center w-full max-w-lg">
            <h1 class="text-3xl font-bold text-indigo-300">Pablo ðŸ¤–</h1>
        </header>

        <!-- Main Chat Window -->
        <div id="chat-window" class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-800 rounded-xl shadow-inner w-full max-w-lg mb-4">
            <!-- Messages will be injected here by JavaScript -->
        </div>

        <!-- Input and Buttons -->
        <div class="relative flex flex-col items-center w-full max-w-lg space-y-2">
            <!-- Story Button -->
            <button id="story-button" class="w-full px-4 py-3 bg-fuchsia-500 text-white rounded-xl hover:bg-fuchsia-400 transition-colors font-semibold shadow-lg">
                âœ¨ Write a Story
            </button>
            <!-- Message Input Bar -->
            <div class="relative flex items-center w-full">
                <textarea id="message-input" class="message-input" rows="1" placeholder="Type your message..."></textarea>
                <button id="send-button" class="absolute right-4 send-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send">
                        <path d="m22 2-7 19-3-6-6-3 19-7z" />
                        <path d="M11 13 9 9" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Story Pop-up -->
    <div id="story-popup" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4 text-center">Tell me a story idea...</h2>
            <textarea id="story-prompt-input" class="w-full p-3 rounded-xl bg-gray-700 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors resize-none" rows="3" placeholder="e.g., A robot who learns to love gardening."></textarea>
            <div class="flex justify-end mt-4 space-x-2">
                <button id="cancel-story-button" class="px-4 py-2 bg-gray-600 text-white rounded-xl hover:bg-gray-500 transition-colors">
                    Cancel
                </button>
                <button id="generate-story-button" class="px-4 py-2 bg-indigo-500 text-white rounded-xl hover:bg-indigo-400 transition-colors">
                    Generate Story
                </button>
            </div>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const storyButton = document.getElementById('story-button');
        const storyPopup = document.getElementById('story-popup');
        const storyPromptInput = document.getElementById('story-prompt-input');
        const generateStoryButton = document.getElementById('generate-story-button');
        const cancelStoryButton = document.getElementById('cancel-story-button');

        let chatHistory = [];
        let isLoading = false;

        const apiKey = "AIzaSyAWYlIZj07qAG9jTLEy2X0nlnQVLwSLxMw";

        const appendMessage = (sender, text) => {
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            messageBubble.innerText = text;

            messageContainer.appendChild(messageBubble);
            chatWindow.appendChild(messageContainer);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        const showLoadingSpinner = () => {
            const spinnerContainer = document.createElement('div');
            spinnerContainer.id = 'loading-spinner';
            spinnerContainer.className = 'flex justify-start';
            spinnerContainer.innerHTML = `
                <div class="bg-gray-700 p-3 rounded-xl rounded-bl-none shadow-md">
                    <div class="flex items-center space-x-2 spinner">
                        <div class="h-2 w-2 rounded-full bg-indigo-400"></div>
                        <div class="h-2 w-2 rounded-full bg-indigo-400"></div>
                        <div class="h-2 w-2 rounded-full bg-indigo-400"></div>
                    </div>
                </div>
            `;
            chatWindow.appendChild(spinnerContainer);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        const hideLoadingSpinner = () => {
            const spinner = document.getElementById('loading-spinner');
            if (spinner) {
                spinner.remove();
            }
        };

        const sendMessage = async () => {
            const input = messageInput.value.trim();
            if (input === '' || isLoading) return;

            isLoading = true;
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.disabled = true;
            sendButton.disabled = true;
            storyButton.disabled = true;

            appendMessage('user', input);
            chatHistory.push({ role: 'user', parts: [{ text: input }] });
            showLoadingSpinner();

            try {
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const aiResponseText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response.";

                chatHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                appendMessage('ai', aiResponseText);

            } catch (error) {
                console.error("Failed to send message:", error);
                appendMessage('ai', "I'm having trouble connecting right now. Please try again later.");
            } finally {
                hideLoadingSpinner();
                isLoading = false;
                messageInput.disabled = false;
                sendButton.disabled = false;
                storyButton.disabled = false;
                messageInput.focus();
            }
        };

        const generateStory = async () => {
            const prompt = storyPromptInput.value.trim();
            if (prompt === '') return;

            storyPopup.classList.add('hidden');
            storyPromptInput.value = '';
            isLoading = true;
            messageInput.disabled = true;
            sendButton.disabled = true;
            storyButton.disabled = true;
            showLoadingSpinner();

            try {
                const storyPrompt = `Write a short, creative story (around 150 words) based on the following idea: "${prompt}"`;
                const payload = { contents: [{ role: 'user', parts: [{ text: storyPrompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const storyText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a story.";

                const storyMessage = `Here is a story for you:\n\n${storyText}`;
                appendMessage('ai', storyMessage);
                chatHistory.push({ role: 'model', parts: [{ text: storyMessage }] });

            } catch (error) {
                console.error("Failed to generate story:", error);
                appendMessage('ai', "I'm having trouble creating a story right now. Please try again later.");
            } finally {
                hideLoadingSpinner();
                isLoading = false;
                messageInput.disabled = false;
                sendButton.disabled = false;
                storyButton.disabled = false;
                messageInput.focus();
            }
        };

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);
        storyButton.addEventListener('click', () => {
            storyPopup.classList.remove('hidden');
            storyPromptInput.focus();
        });
        cancelStoryButton.addEventListener('click', () => {
            storyPopup.classList.add('hidden');
            storyPromptInput.value = '';
        });
        generateStoryButton.addEventListener('click', generateStory);

        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
        });

    </script>

</body>
</html>
